<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://re-panza.github.io/lk_tool/version.js"></script>
  <script>
    if (typeof APP_VERSION !== 'undefined') {
        document.write(`<link rel="manifest" href="https://re-panza.github.io/lk_tool/manifest.json?v=${APP_VERSION}">`);
    }
  </script>
  <link rel="apple-touch-icon" href="https://re-panza.github.io/lk_tool/icona.png">
  <title>L&K: Calcola Partenze</title>
  
  <style>
    :root { --bg:#0f172a; --card:#111c33; --muted:#93a4c7; --text:#e8eefc; --accent:#60a5fa; --border:rgba(255,255,255,.10); --success:#34d399; --gold:#fbbf24; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:radial-gradient(1200px 600px at 20% 0%,rgba(96,165,250,.25),transparent 60%),radial-gradient(1000px 500px at 90% 10%,rgba(52,211,153,.18),transparent 55%),var(--bg); color:var(--text); padding:env(safe-area-inset-top,20px) 20px 80px 20px; min-height:100vh; user-select:none; }
    input, textarea, .selectable { user-select:text; }
    .wrap { max-width:800px; margin:0 auto; }
    .top-nav { max-width:800px; margin:0 auto 15px auto; }
    .home-link { text-decoration:none; color:var(--accent); font-weight:bold; display:inline-flex; align-items:center; gap:8px; font-size:14px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    h1 { font-size:24px; margin:0; color:#fff; font-weight:800; }
    .card { background:rgba(17,28,51,.85); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25); margin-bottom:20px; backdrop-filter:blur(10px); }
    .card h2 { margin-top:0; font-size:16px; color:var(--accent); display:flex; align-items:center; gap:8px;}
    label { display:block; color:var(--muted); font-size:12px; text-transform:uppercase; margin-bottom:5px; font-weight:bold; }
    input, select, textarea { width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.05); color:var(--text); outline:none; font-size:15px; font-family:inherit; transition:0.2s; }
    input:focus, select:focus, textarea:focus { border-color:var(--accent); background:rgba(255,255,255,0.1); }
    .row { display:flex; gap:15px; margin-bottom:15px; }
    .col { flex:1; }
    .chk-group { display:flex; flex-direction:column; gap:8px; margin-bottom:15px; }
    .chk-label { display:flex; align-items:center; gap:10px; font-size:13px; color:var(--text); cursor:pointer; }
    .chk-label input { width:18px; height:18px; accent-color:var(--accent); margin:0; }
    button { width:100%; padding:14px; border-radius:12px; font-weight:800; border:1px solid var(--accent); background:rgba(96,165,250,.15); color:var(--accent); cursor:pointer; text-transform:uppercase; font-size:14px; transition:0.2s; }
    button:active { transform:scale(0.98); background:var(--accent); color:#000; }
    .btn-green { border-color:var(--success); background:rgba(52,211,153,0.15); color:var(--success); }
    .btn-green:active { background:var(--success); color:#000; }
    .res-card { background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:14px; padding:15px; margin-bottom:12px; position:relative; overflow:hidden; }
    .res-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--gold); }
    .res-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
    .res-target { font-weight:800; font-size:16px; color:#fff; }
    .res-coords { font-family:monospace; color:var(--muted); font-size:13px; }
    .res-route { display:flex; align-items:center; gap:10px; font-size:13px; background:rgba(0,0,0,0.2); padding:8px; border-radius:8px; margin-bottom:10px; }
    .route-arrow { color:var(--muted); font-size:16px; }
    .route-info b { color:var(--gold); }
    .res-time-box { text-align:center; background:rgba(251,191,36,0.1); border:1px dashed var(--gold); border-radius:10px; padding:10px; }
    .launch-label { font-size:11px; color:var(--gold); text-transform:uppercase; font-weight:bold; }
    .launch-time { font-size:20px; font-weight:800; color:#fff; margin:4px 0; }
    .launch-date { font-size:12px; color:var(--muted); }
    .copy-btn { margin-top:8px; padding:8px; font-size:12px; border-radius:8px; background:transparent; border:1px solid var(--border); color:var(--muted); }
    #errorBanner { display:none; padding:12px; background:rgba(239,68,68,0.2); border:1px solid rgba(239,68,68,0.5); color:#ffcccc; border-radius:12px; margin-bottom:20px; font-weight:bold; text-align:center; }
    .loader { border:3px solid rgba(255,255,255,0.1); border-top:3px solid var(--accent); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:8px; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
    .tag-active { color:var(--success); font-weight:bold; font-size:12px; margin-top:5px; }

    .paypal-footer { text-align:center; margin-top:60px; padding:30px 20px; border-top:1px solid rgba(255,255,255,0.1); }
    .paypal-link { text-decoration:none; font-weight:700; font-size:14px; display:inline-flex; align-items:center; gap:10px; transition:all 0.3s ease; color:#fff !important; background:#0070ba; padding:12px 28px; border-radius:50px; box-shadow:0 4px 15px rgba(0,112,186,0.3); border:none; }
    .paypal-link:hover { background:#005ea6; transform:translateY(-2px); }
    
    #ai-assistant-container { position:fixed; bottom:20px; right:20px; z-index:9999; }
    #ai-button { width:70px; height:70px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.4); border:2px solid var(--accent); overflow:hidden; }
    #ai-button img { width:100%; height:100%; object-fit:cover; }
    #ai-window { display:none; position:absolute; bottom:85px; right:0; width:85vw; max-width:320px; background:var(--card); border:1px solid var(--accent); border-radius:20px; padding:15px; box-shadow:0 10px 30px rgba(0,0,0,0.6); }
    .ai-header { color:var(--accent); font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding-bottom:5px; }
    .ai-input-area { display:flex; gap:5px; border-top:1px solid var(--border); padding-top:10px; }
    #ai-input { flex:1; background:#000; border:1px solid var(--border); color:#fff; border-radius:5px; padding:8px; font-size:12px; }
    #ai-send-btn { background:var(--accent); border:none; border-radius:5px; padding:5px 15px; cursor:pointer; font-weight:bold; color:#000; }
  </style>
</head>
<body>

  <div class="top-nav">
    <a href="https://re-panza.github.io/lk_tool/" class="home-link">
      <span data-lang="nav_home">üè† Home</span>
    </a>
  </div>

  <div class="wrap">
    <header><h1 data-lang="cp_title">‚öîÔ∏è Calcola Partenze</h1></header>
    <div id="errorBanner"></div>

    <div class="card">
        <h2 data-lang="lbl_attacker">üë§ Profilo Attaccante</h2>
        <div class="row"><div class="col"><input type="text" id="attackerLink" placeholder="l+k://player?123&337" onchange="fetchAttackerData()"><div id="attackerStatus" class="tag-active" style="display:none"></div></div></div>
        <div class="row">
            <div class="col"><label>Strutture</label><select id="structureLevel"></select></div>
            <div class="col"><label>Evento</label><select id="speedEvent"><option value="0">Normale</option><option value="100">‚ö° 100%</option></select></div>
        </div>
        <div class="chk-group">
            <label class="chk-label"><input type="checkbox" id="chkMap"> üó∫Ô∏è Mappa Area (Castelli)</label>
            <label class="chk-label"><input type="checkbox" id="chkCompass"> üß≠ Bussola (Fortezze)</label>
            <label class="chk-label"><input type="checkbox" id="chkManeuver"> üêé Manovra (Metro)</label>
        </div>
    </div>

    <div class="card">
        <h2>üéØ Configurazione</h2>
        <div class="row"><div class="col"><label data-lang="lbl_date">Data</label><input type="date" id="impactDate"></div><div class="col"><label data-lang="lbl_time">Ora</label><input type="time" id="impactTime" step="1"></div></div>
        <div class="row"><div class="col"><label data-lang="lbl_troop">Truppa</label><select id="troopType"></select></div></div>
        <label data-lang="lbl_targets">üîó Link Bersagli</label>
        <textarea id="targetList" placeholder="..."></textarea>
        <button class="btn-green" onclick="calculateDepartures()" style="margin-top:15px;" data-lang="btn_calc">CALCOLA</button>
    </div>

    <div id="resultsArea"></div>
  </div>

  <footer class="paypal-footer"><a href="https://paypal.me/Longo11" target="_blank" class="paypal-link" data-lang="footer_coffee">‚òï PayPal</a></footer>

  <div id="ai-assistant-container"><div id="ai-window"><div class="ai-header"><span>üëë Re Panza</span><span onclick="toggleAI()" style="cursor:pointer">√ó</span></div><div id="ai-content"><p>Ciao!</p></div><div class="ai-input-area"><input type="text" id="ai-input" placeholder="..."><button id="ai-send-btn" onclick="chiediAlRe()">Invia</button></div></div><div id="ai-button" onclick="toggleAI()"><img src="https://re-panza.github.io/lk_tool/re-panza-ai.png" alt="AI"></div></div>

  <script src="https://re-panza.github.io/lk_tool/common.js"></script>
  <script src="https://re-panza.github.io/re-panza-core/re_panza_brain.js"></script>

  <script>
    let GAME_DATA = null, ATTACKER_CASTLES = [], CURRENT_WORLD = null;

    window.onload = async () => {
        let lvlHtml = ""; for(let i=30; i>=1; i--) lvlHtml += `<option value="${i}">Livello ${i}</option>`;
        document.getElementById('structureLevel').innerHTML = lvlHtml;
        GAME_DATA = await LK_API.loadGameConfig();
        if(GAME_DATA) {
            let tHtml = ""; for (const k of Object.keys(GAME_DATA.troops_base_seconds)) tHtml += `<option value="${k}">${k}</option>`;
            document.getElementById('troopType').innerHTML = tHtml;
        }
    };

    async function fetchAttackerData() {
        const link = document.getElementById('attackerLink').value;
        const m = link.match(/player\?(\d+)&(\d+)/);
        if(!m) return showError("Link non valido");
        const pid = parseInt(m[1]), wid = m[2];
        const statusDiv = document.getElementById('attackerStatus');

        if(CURRENT_WORLD !== wid) {
            statusDiv.innerHTML = `<span class="loader"></span> Carico Mondo ${wid}...`; statusDiv.style.display = 'block';
            const data = await LK_API.fetchWorldData(wid);
            if(!data) { statusDiv.style.display='none'; return; }
            window.WORLD_DB = data.db; CURRENT_WORLD = wid;
        }
        ATTACKER_CASTLES = window.WORLD_DB.filter(c => (c.p || c.pid || c.playerid) == pid);
        if(ATTACKER_CASTLES.length > 0) {
            statusDiv.innerHTML = `‚úÖ Trovati ${ATTACKER_CASTLES.length} castelli`; statusDiv.style.color = 'var(--success)';
            document.getElementById('errorBanner').style.display = 'none';
        } else showError("Nessun castello trovato.");
    }

    function calculateDepartures() {
        if(!ATTACKER_CASTLES.length) return showError("Carica profilo!");
        const impactD = document.getElementById('impactDate').value, impactT = document.getElementById('impactTime').value;
        if(!impactD || !impactT) return showError("Data/Ora mancanti");
        const impactDateObj = new Date(impactD + "T" + impactT);
        
        const targets = [];
        let match; const regex = /coordinates\?(\d+),(\d+)&(\d+)/g;
        while ((match = regex.exec(document.getElementById('targetList').value)) !== null) {
            if(match[3] !== CURRENT_WORLD) { showError("Mondo errato nei target!"); continue; }
            targets.push({ x: parseInt(match[1]), y: parseInt(match[2]) });
        }
        if(!targets.length) return showError("Nessun target valido.");

        const troopKey = document.getElementById('troopType').value;
        const speedEvent = document.getElementById('speedEvent').value === "100";
        const structLvl = parseInt(document.getElementById('structureLevel').value);
        const hasMap = document.getElementById('chkMap').checked;
        const hasCompass = document.getElementById('chkCompass').checked;
        const hasManeuver = document.getElementById('chkManeuver').checked;
        
        const resDiv = document.getElementById('resultsArea'); resDiv.innerHTML = "";

        targets.forEach((target, idx) => {
            let bestSource = null, maxTravelTime = 0; 
            ATTACKER_CASTLES.forEach(source => {
                const dist = getDist(source.x, source.y, target.x, target.y);
                if(dist === 0) return; 
                let habType = "castello"; if(source.t==2) habType="fortezza"; if(source.t==4) habType="citta"; if(source.t>4) habType="metropoli";
                
                let base = GAME_DATA.troops_base_seconds[troopKey];
                let config = GAME_DATA.habitats[habType];
                let factor = config.base_multiplier;
                if(habType === "citta" || habType === "metropoli") {
                    if(config.building_levels && config.building_levels[structLvl]) factor *= config.building_levels[structLvl];
                }
                if(habType==="castello" && hasMap) factor *= 0.95;
                if(habType==="fortezza"
