<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://re-panza.github.io/lk_tool/icona.png">

    <title>Calcolo Partenze - L&K Tool</title>

    <script src="https://re-panza.github.io/lk_tool/version.js"></script>
    <script>
        if (typeof APP_VERSION !== 'undefined') {
            document.write(`<link rel="manifest" href="https://re-panza.github.io/lk_tool/manifest.json?v=${APP_VERSION}">`);
        }
    </script>
    
    <script src="common.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --card: #111c33;
            --muted: #93a4c7;
            --text: #e8eefc;
            --accent: #60a5fa;
            --border: rgba(255, 255, 255, 0.1);
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            padding-bottom: 80px;
        }

        h2 {
            text-align: center;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }

        /* --- Input Styles --- */
        .input-group {
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        label {
            display: block;
            color: var(--muted);
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- Search Results --- */
        #searchResults {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: none;
            background: var(--bg);
        }

        .search-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .search-item:hover {
            background: rgba(96, 165, 250, 0.2);
        }

        .search-name { color: var(--accent); font-weight: bold; }
        .search-coord { float: right; font-family: monospace; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 4px; }
        .search-details { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }

        /* --- Target List (Cards) --- */
        .target-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .target-name { font-weight: bold; color: var(--text); font-size: 1.1rem; }
        .target-coords { color: var(--accent); font-family: monospace; font-size: 1rem; }
        
        .remove-btn {
            background: none; border: none; color: var(--danger); font-size: 1.2rem; cursor: pointer;
        }

        /* --- Results Box inside Card --- */
        .result-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            display: none; /* Hidden by default */
        }
        .result-box.visible { display: block; }
        
        .launch-time { color: var(--success); font-weight: bold; font-size: 1.1rem; margin: 5px 0; }
        .arrival-time { color: var(--warning); font-size: 0.9rem; }

        .btn-calc {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body>

    <h2>üéØ Calcolo Partenze</h2>

    <div class="input-group">
        <label>üìç Le tue Coordinate (Partenza)</label>
        <div style="display:flex; gap:10px;">
            <input type="number" id="startX" placeholder="X" onchange="recalcAll()">
            <input type="number" id="startY" placeholder="Y" onchange="recalcAll()">
        </div>
    </div>

    <div class="input-group">
        <label>‚è∞ Data e Ora di ARRIVO (Impact)</label>
        <div style="display:flex; gap:10px;">
            <input type="date" id="inDate" onchange="recalcAll()">
            <input type="time" id="inTime" step="1" onchange="recalcAll()">
        </div>
    </div>

    <div class="input-group">
        <label>üîç Cerca Bersaglio (Nome Giocatore, Castello, Alleanza)</label>
        <input type="text" id="searchBox" placeholder="Es. Re Panza..." onkeyup="doSearch()">
        <div id="searchResults"></div>
    </div>

    <div id="targetListArea"></div>

    <script>
        // --- CONFIGURAZIONE DATABASE ---
        const DB_FILE = "database_mondo_327.json"; // File unico aggiornato
        
        // --- DATABASE INTERNO ---
        let fullDb = [];
        let selectedTargets = [];

        // Velocit√† truppe (minuti per campo)
        const SPEEDS = {
            "lanceri": 2, "spadaccini": 2, "arcieri": 2, "balestrieri": 2,
            "cavalieri": 1, "cav_pesante": 1,
            "carro": 6, "ariete": 6, "trabucco": 6,
            "argenteus": 4 // Velocit√† transito
        };

        // --- INIZIALIZZAZIONE ---
        document.addEventListener("DOMContentLoaded", () => {
            // Imposta data odierna di default
            document.getElementById('inDate').valueAsDate = new Date();
            
            // Carica il DB Unificato
            loadDatabase();
        });

        async function loadDatabase() {
            const searchBox = document.getElementById('searchBox');
            searchBox.placeholder = "Caricamento database...";
            searchBox.disabled = true;

            try {
                const response = await fetch(DB_FILE);
                if (!response.ok) throw new Error("Errore file JSON");
                const data = await response.json();
                
                // Filtro: solo castelli validi (con ID giocatore > 0)
                fullDb = data.filter(c => c.p && c.p > 0);
                
                searchBox.placeholder = `Cerca tra ${fullDb.length} castelli...`;
                searchBox.disabled = false;
                console.log("Database caricato:", fullDb.length, "record.");
            } catch (error) {
                console.error(error);
                searchBox.placeholder = "Errore caricamento database!";
            }
        }

        // --- LOGICA DI RICERCA (Adattata al nuovo JSON) ---
        function doSearch() {
            const query = document.getElementById('searchBox').value.toLowerCase();
            const resDiv = document.getElementById('searchResults');
            resDiv.innerHTML = "";
            
            if (query.length < 3) {
                resDiv.style.display = 'none';
                return;
            }

            // Cerca per: Nome Giocatore (pn), Nome Castello (n), Alleanza (a)
            const results = fullDb.filter(c => {
                const matchPn = c.pn && c.pn.toLowerCase().includes(query);
                const matchN = c.n && c.n.toLowerCase().includes(query);
                const matchA = c.a && c.a.toString().includes(query);
                return matchPn || matchN || matchA;
            }).slice(0, 10); // Max 10 risultati

            if (results.length > 0) {
                resDiv.style.display = 'block';
                results.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerHTML = `
                        <span class="search-name">${c.pn || "Sconosciuto"}</span> 
                        <span class="search-coord">${c.x}:${c.y}</span>
                        <div class="search-details">üè∞ ${c.n} | üõ°Ô∏è Ally: ${c.a}</div>
                    `;
                    div.onclick = () => addTarget(c);
                    resDiv.appendChild(div);
                });
            } else {
                resDiv.style.display = 'none';
            }
        }

        // --- GESTIONE TARGET ---
        function addTarget(castle) {
            // Pulisci ricerca
            document.getElementById('searchBox').value = "";
            document.getElementById('searchResults').style.display = 'none';

            // Aggiungi a lista
            const id = Date.now(); // ID univoco per il DOM
            selectedTargets.push({ id: id, data: castle });
            
            renderTarget(id, castle);
        }

        function removeTarget(id) {
            selectedTargets = selectedTargets.filter(t => t.id !== id);
            document.getElementById(`card_${id}`).remove();
        }

        function renderTarget(id, c) {
            const container = document.getElementById('targetListArea');
            const div = document.createElement('div');
            div.className = 'target-card';
            div.id = `card_${id}`;
            
            div.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="target-name">${c.pn} - ${c.n}</div>
                        <div class="target-coords">Coord: ${c.x}:${c.y}</div>
                    </div>
                    <button class="remove-btn" onclick="removeTarget(${id})">&times;</button>
                </div>
                
                <label>Velocit√† Truppa pi√π lenta:</label>
                <select id="sel_${id}" onchange="calcOne(${id})">
                    <option value="" disabled selected>Seleziona truppa...</option>
                    <option value="6">Carro / Ariete / Trabucco (6 min)</option>
                    <option value="4">Argenteus (4 min)</option>
                    <option value="2">Fanteria / Arcieri (2 min)</option>
                    <option value="1">Cavalleria (1 min)</option>
                </select>

                <div id="res_${id}" class="result-box"></div>
            `;
            
            // Inserisci in cima
            container.prepend(div);
            // Prova a calcolare subito se ci sono le coord di partenza
            calcOne(id);
        }

        // --- LOGICA DI CALCOLO ---
        function getDistance(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        function pad(n) { return n < 10 ? '0' + n : n; }

        function calcOne(id) {
            const startX = parseInt(document.getElementById('startX').value);
            const startY = parseInt(document.getElementById('startY').value);
            const dateVal = document.getElementById('inDate').value;
            const timeVal = document.getElementById('inTime').value;
            const speed = parseInt(document.getElementById(`sel_${id}`).value);

            const resBox = document.getElementById(`res_${id}`);
            
            // Validazione base
            if (!startX || !startY || !dateVal || !timeVal || !speed) {
                resBox.classList.remove('visible');
                return;
            }

            // Trova dati target
            const targetObj = selectedTargets.find(t => t.id === id);
            if (!targetObj) return;
            const tx = targetObj.data.x;
            const ty = targetObj.data.y;

            // 1. Calcolo Distanza
            const dist = getDistance(startX, startY, tx, ty);
            
            // 2. Calcolo Tempo Viaggio (minuti) = Distanza * Velocit√†
            const travelMinutes = dist * speed;
            const travelMs = travelMinutes * 60 * 1000;

            // 3. Data Arrivo (Impact)
            const impactDate = new Date(`${dateVal}T${timeVal}`);
            
            // 4. Data Partenza = Arrivo - Viaggio
            const launchDate = new Date(impactDate.getTime() - travelMs);

            // Formattazione
            const fmtDate = (d) => `${pad(d.getDate())}/${pad(d.getMonth()+1)} ore ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

            resBox.innerHTML = `
                <div>Distanza: <b>${dist.toFixed(2)}</b> campi</div>
                <div>Viaggio: <b>${Math.floor(travelMinutes)}m ${Math.round((travelMinutes%1)*60)}s</b></div>
                <hr style="border-color:rgba(255,255,255,0.1)">
                <div style="font-size:0.9rem; color:#aaa">DEVI PARTIRE IL:</div>
                <div class="launch-time">${fmtDate(launchDate)}</div>
                <div class="arrival-time">per arrivare alle ${timeVal}</div>
            `;
            resBox.classList.add('visible');
        }

        function recalcAll() {
            selectedTargets.forEach(t => calcOne(t.id));
        }

    </script>
</body>
</html>
