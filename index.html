<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <script src="https://re-panza.github.io/lk_tool/version.js"></script>
  <script>
    if (typeof APP_VERSION !== 'undefined') {
        document.write(`<link rel="manifest" href="https://re-panza.github.io/lk_tool/manifest.json?v=${APP_VERSION}">`);
    }
  </script>
  <link rel="apple-touch-icon" href="https://re-panza.github.io/lk_tool/icona.png">
  <title>L&K: Calcola Partenze</title>
  
  <style>
    :root {
      --bg: #0f172a;
      --card: #111c33;
      --muted: #93a4c7;
      --text: #e8eefc;
      --accent: #60a5fa;
      --border: rgba(255, 255, 255, .10);
      --success: #34d399;
      --gold: #fbbf24;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(1000px 500px at 90% 10%, rgba(52,211,153,.18), transparent 55%),
                  var(--bg);
      color: var(--text);
      padding: env(safe-area-inset-top, 20px) 20px 80px 20px;
      min-height: 100vh;
      -webkit-user-select: none; user-select: none;
    }

    /* Input text areas selectable */
    input, textarea, .selectable { -webkit-user-select: text; user-select: text; }

    .wrap { max-width: 800px; margin: 0 auto; }

    .top-nav { max-width: 800px; margin: 0 auto 15px auto; }
    .home-link {
      text-decoration: none; color: var(--accent); font-weight: bold; 
      display: inline-flex; align-items: center; gap: 8px; font-size: 14px;
    }

    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    h1 { font-size: 24px; margin: 0; color: #fff; font-weight: 800; }
    
    .card {
      background: rgba(17, 28, 51, .85);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }

    .card h2 { margin-top:0; font-size: 16px; color: var(--accent); display:flex; align-items:center; gap:8px;}

    label { display: block; color: var(--muted); font-size: 12px; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }

    input, select, textarea {
      width: 100%; padding: 12px; border-radius: 12px;
      border: 1px solid var(--border); background: rgba(255, 255, 255, .05);
      color: var(--text); outline: none; font-size: 15px; font-family: inherit;
      transition: 0.2s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }

    .row { display: flex; gap: 15px; margin-bottom: 15px; }
    .col { flex: 1; }

    button {
      width: 100%; padding: 14px; border-radius: 12px; font-weight: 800;
      border: 1px solid var(--accent); background: rgba(96, 165, 250, .15);
      color: var(--accent); cursor: pointer; text-transform: uppercase;
      font-size: 14px; transition: 0.2s;
    }
    button:active { transform: scale(0.98); background: var(--accent); color: #000; }

    .btn-green { border-color: var(--success); background: rgba(52, 211, 153, 0.15); color: var(--success); }
    .btn-green:active { background: var(--success); color: #000; }

    /* RESULTS STYLE */
    .res-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 15px;
        margin-bottom: 12px;
        position: relative;
        overflow: hidden;
    }
    .res-card::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        background: var(--accent);
    }
    
    .res-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .res-target { font-weight: 800; font-size: 16px; color: #fff; }
    .res-coords { font-family: monospace; color: var(--muted); font-size: 13px; }

    .res-route {
        display: flex; align-items: center; gap: 10px; font-size: 13px;
        background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; margin-bottom: 10px;
    }
    .route-arrow { color: var(--muted); font-size: 16px; }
    .route-info b { color: var(--gold); }

    .res-time-box {
        text-align: center;
        background: rgba(96, 165, 250, 0.1);
        border: 1px dashed var(--accent);
        border-radius: 10px;
        padding: 10px;
    }
    .launch-label { font-size: 11px; color: var(--accent); text-transform: uppercase; font-weight: bold; }
    .launch-time { font-size: 20px; font-weight: 800; color: #fff; margin: 4px 0; }
    .launch-date { font-size: 12px; color: var(--muted); }

    .copy-btn {
        margin-top: 8px; padding: 8px; font-size: 12px; border-radius: 8px;
        background: transparent; border: 1px solid var(--border); color: var(--muted);
    }

    #errorBanner {
        display: none; padding: 12px; background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.5); color: #ffcccc;
        border-radius: 12px; margin-bottom: 20px; font-weight: bold; text-align: center;
    }

    /* Loading Spinner */
    .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .tag-active { color: var(--success); font-weight: bold; font-size: 12px; margin-top: 5px; }
  </style>
</head>
<body>

  <div class="top-nav">
    <a href="https://re-panza.github.io/lk_tool/" class="home-link">
      <span style="font-size:20px;">üè†</span> Torna alla Home
    </a>
  </div>

  <div class="wrap">
    <header>
      <h1>‚öîÔ∏è Calcola Partenze</h1>
    </header>

    <div id="errorBanner"></div>

    <div class="card">
        <h2>üë§ Profilo Attaccante</h2>
        <div class="row">
            <div class="col">
                <label>Incolla Link Profilo Attaccante</label>
                <input type="text" id="attackerLink" placeholder="l+k://player?123&337" onchange="fetchAttackerData()">
                <div id="attackerStatus" class="tag-active" style="display:none"></div>
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <label>Livello Strutture (Caserma/Accademia)</label>
                <select id="structureLevel"></select>
            </div>
            <div class="col">
                <label>Evento Velocit√†</label>
                <select id="speedEvent">
                    <option value="0">Nessuno (Normale)</option>
                    <option value="100">‚ö° Velocit√† 100%</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>üéØ Configurazione Attacco</h2>
        <div class="row">
            <div class="col">
                <label>üìÖ Data Impatto</label>
                <input type="date" id="impactDate">
            </div>
            <div class="col">
                <label>üïí Ora Impatto</label>
                <input type="time" id="impactTime" step="1">
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <label>Truppa da Inviare</label>
                <select id="troopType"></select>
            </div>
        </div>

        <label>üîó Link Bersagli (Uno per riga)</label>
        <textarea id="targetList" placeholder="Incolla qui i link dei castelli da attaccare..."></textarea>
        
        <button class="btn-green" onclick="calculateDepartures()" style="margin-top:15px;">üöÄ CALCOLA PARTENZE</button>
    </div>

    <div id="resultsArea"></div>

  </div>

  <footer style="text-align:center; padding:30px 20px; color:var(--muted); font-size:12px; border-top:1px solid var(--border); margin-top:40px;">
    <p>Sviluppato da Re Panza</p>
    <a href="https://paypal.me/Longo11" target="_blank" style="color:#60a5fa; text-decoration:none; font-weight:bold;">‚òï Offrimi un caff√®</a>
  </footer>

  <div id="ai-assistant-container" style="position:fixed; bottom:20px; right:20px; z-index:9999;">
    <div id="ai-window" style="display:none; position:absolute; bottom:85px; right:0; width:85vw; max-width:320px; background:var(--card); border:1px solid var(--accent); border-radius:20px; padding:15px; box-shadow:0 10px 30px rgba(0,0,0,0.6);">
        <div class="ai-header" style="color:var(--accent); font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding-bottom:5px;">
            <span>üëë Re Panza</span>
            <span onclick="toggleAI()" style="cursor:pointer">√ó</span>
        </div>
        <div id="ai-content" style="max-height:250px; overflow-y:auto; margin-bottom:10px; font-size:13px; color:var(--text);">
            <p>Ciao! Carica il tuo profilo, scegli i bersagli e ti dir√≤ io da dove partire per arrivare puntuale come un'arrosto.</p>
        </div>
        <div class="ai-input-area" style="display:flex; gap:5px; border-top:1px solid var(--border); padding-top:10px;">
            <input type="text" id="ai-input" placeholder="Chiedi al Re..." style="flex:1; background:#000; border:1px solid var(--border); color:#fff; border-radius:5px; padding:8px; font-size:12px;">
            <button id="ai-send-btn" onclick="chiediAlRe()" style="background:var(--accent); border:none; border-radius:5px; padding:5px 15px; cursor:pointer; font-weight:bold; color:#000;">Invia</button>
        </div>
    </div>
    <div id="ai-button" onclick="toggleAI()" style="width:70px; height:70px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.4); border:2px solid var(--accent); overflow:hidden;">
        <img src="https://re-panza.github.io/lk_tool/re-panza-ai.png" alt="AI" style="width:100%; height:100%; object-fit:cover;">
    </div>
  </div>

  <script src="https://re-panza.github.io/lk_tool/common.js"></script>
  <script src="https://re-panza.github.io/re-panza-core/re_panza_brain.js"></script>

  <script>
    let GAME_DATA = null;
    let ATTACKER_CASTLES = [];
    let WORLD_DB = [];
    let CURRENT_WORLD = null;

    // --- INIT ---
    window.onload = async () => {
        // Popola Livelli (Default 30)
        let lvlHtml = "";
        for(let i=30; i>=1; i--) lvlHtml += `<option value="${i}">Livello ${i}</option>`;
        document.getElementById('structureLevel').innerHTML = lvlHtml;

        // Carica Dati Gioco
        await loadGameConfig();
    };

    async function loadGameConfig() {
        try {
            const r = await fetch('https://raw.githubusercontent.com/Re-Panza/lk_database/main/database_truppe.json?v=' + Date.now());
            if(!r.ok) throw new Error("Errore config");
            const json = await r.json();
            GAME_DATA = json.game_config;
            
            // Popola Truppe
            let tHtml = "";
            for (const [key, val] of Object.entries(GAME_DATA.troops_base_seconds)) {
                tHtml += `<option value="${key}">${key}</option>`;
            }
            document.getElementById('troopType').innerHTML = tHtml;

        } catch(e) {
            showError("Errore caricamento dati truppe. Riprova.");
        }
    }

    // --- FETCH ATTACKER ---
    async function fetchAttackerData() {
        const link = document.getElementById('attackerLink').value;
        const m = link.match(/player\?(\d+)&(\d+)/);
        
        if(!m) {
            showError("Link giocatore non valido!");
            return;
        }

        const playerId = parseInt(m[1]);
        const worldId = m[2];
        const statusDiv = document.getElementById('attackerStatus');

        if(CURRENT_WORLD !== worldId) {
            statusDiv.innerHTML = `<span class="loader"></span> Carico Mondo ${worldId}...`;
            statusDiv.style.display = 'block';
            
            try {
                // Logica URL diversa per mondo 327 (come negli altri file)
                let urlDB = "";
                if(worldId === "327") {
                    urlDB = "https://raw.githubusercontent.com/Re-Panza/lk_scanner/main/database_mondo_327.json";
                } else {
                    urlDB = `https://raw.githubusercontent.com/Re-Panza/lk_database/main/database_mondo_${worldId}.json`;
                }

                const r = await fetch(urlDB + "?v=" + Date.now());
                if(!r.ok) throw new Error("Mondo non trovato");
                
                const rawData = await r.json();
                WORLD_DB = [];
                // Flatten DB se necessario
                const flat = (n) => { 
                    if(Array.isArray(n)) n.forEach(flat); 
                    else if(n && n.x) WORLD_DB.push(n); 
                    else if(typeof n==='object') Object.values(n).forEach(flat); 
                };
                flat(rawData);
                
                CURRENT_WORLD = worldId;
            } catch(e) {
                showError("Errore caricamento Database Mondo " + worldId);
                statusDiv.style.display = 'none';
                return;
            }
        }

        // Filtra castelli del giocatore
        ATTACKER_CASTLES = WORLD_DB.filter(c => (c.p || c.pid || c.playerid) == playerId);
        
        if(ATTACKER_CASTLES.length > 0) {
            statusDiv.innerHTML = `‚úÖ Profilo Caricato: Trovati ${ATTACKER_CASTLES.length} castelli nel Mondo ${worldId}`;
            statusDiv.style.color = 'var(--success)';
            document.getElementById('errorBanner').style.display = 'none';
        } else {
            showError("Nessun castello trovato per questo giocatore.");
        }
    }

    // --- CALCOLO PRINCIPALE ---
    function calculateDepartures() {
        if(ATTACKER_CASTLES.length === 0) return showError("Carica prima il profilo attaccante!");
        if(!GAME_DATA) return showError("Dati gioco non caricati.");

        const impactD = document.getElementById('impactDate').value;
        const impactT = document.getElementById('impactTime').value;
        if(!impactD || !impactT) return showError("Inserisci Data e Ora Impatto!");

        const impactDateObj = new Date(impactD + "T" + impactT);
        if(isNaN(impactDateObj.getTime())) return showError("Data non valida");

        const targetText = document.getElementById('targetList').value;
        const targets = [];
        const linkRegex = /coordinates\?(\d+),(\d+)&(\d+)/g;
        let match;

        while ((match = linkRegex.exec(targetText)) !== null) {
            if(match[3] !== CURRENT_WORLD) {
                showError(`Attenzione: Alcuni bersagli non sono del Mondo ${CURRENT_WORLD}!`);
                continue;
            }
            targets.push({ x: parseInt(match[1]), y: parseInt(match[2]) });
        }

        if(targets.length === 0) return showError("Nessun bersaglio valido trovato.");

        const troopKey = document.getElementById('troopType').value;
        const speedEvent = document.getElementById('speedEvent').value === "100";
        const structLvl = parseInt(document.getElementById('structureLevel').value);
        
        const resDiv = document.getElementById('resultsArea');
        resDiv.innerHTML = "";

        targets.forEach((target, idx) => {
            // 1. Trova il castello attaccante pi√π vicino
            let bestSource = null;
            let minTravelTime = Infinity;

            ATTACKER_CASTLES.forEach(source => {
                const dist = getDist(source.x, source.y, target.x, target.y);
                if(dist === 0) return; // Se stesso

                // Calcola velocit√† in base al tipo di habitat di partenza
                const habType = getHabitatType(source.t); // 0=Castello, 2=Fortezza, 4=Citt√†/Metro
                const speed = calculateSpeed(troopKey, habType, structLvl, speedEvent);
                
                const travelTimeSeconds = dist * speed;
                
                if(travelTimeSeconds < minTravelTime) {
                    minTravelTime = travelTimeSeconds;
                    bestSource = { ...source, dist: dist, typeName: habType };
                }
            });

            if(bestSource) {
                // Calcola orari
                const depDate = new Date(impactDateObj.getTime() - (minTravelTime * 1000));
                
                renderResultCard(resDiv, idx+1, target, bestSource, depDate, troopKey);
            } else {
                resDiv.innerHTML += `<div class="res-card"><div style="color:red">Bersaglio #${idx+1}: Nessun castello raggiungibile trovabile.</div></div>`;
            }
        });
    }

    // --- FUNZIONI DI CALCOLO VELOCIT√Ä ---
    function getHabitatType(t) {
        // Mapping tipo DB -> Stringa JSON
        // Nel JSON abbiamo: castello, fortezza, citta, metropoli
        // Nel DB solitamente: 0=Castello, 2=Fortezza, 4=Citt√† (o metro?)
        // Assumiamo:
        if(t == 0) return "castello";
        if(t == 2) return "fortezza";
        if(t == 4) return "citta"; // Assumiamo citt√† base, metro √® rara da distinguere senza altri dati
        return "castello"; // Fallback
    }

    function calculateSpeed(troopKey, habType, lvl, isEvent100) {
        let base = GAME_DATA.troops_base_seconds[troopKey];
        let config = GAME_DATA.habitats[habType];
        
        // Moltiplicatore Base (es. 1.0, 0.95)
        let factor = config.base_multiplier;

        // Se Citt√†/Metro, applica bonus livello
        if(habType === "citta" || habType === "metropoli") {
            if(config.building_levels && config.building_levels[lvl]) {
                factor = factor * config.building_levels[lvl];
            }
        }

        // Evento 100% (Dimezza tempo) -> Moltiplicatore 0.5
        if(isEvent100) factor = factor * 0.5;

        return base * factor;
    }

    function getDist(x1, y1, x2, y2) {
        let cy1 = y1;
        let cz1 = x1 - Math.floor(y1 / 2);
        let cx1 = -cy1 - cz1;
        let cy2 = y2;
        let cz2 = x2 - Math.floor(y2 / 2);
        let cx2 = -cy2 - cz2;
        return Math.max(Math.abs(cx1 - cx2), Math.abs(cy1 - cy2), Math.abs(cz1 - cz2));
    }

    // --- RENDER ---
    function renderResultCard(container, idx, target, source, depDate, troop) {
        const timeStr = depDate.toLocaleTimeString('it-IT');
        const dateStr = depDate.toLocaleDateString('it-IT');
        
        // Copia per PC
        const targetLink = `l+k://coordinates?${target.x},${target.y}&${CURRENT_WORLD}`;
        const sourceLink = `l+k://coordinates?${source.x},${source.y}&${CURRENT_WORLD}`;

        const html = `
        <div class="res-card">
            <div class="res-header">
                <div>
                    <div class="res-target">BERSAGLIO #${idx}</div>
                    <div class="res-coords">
                        <a href="#" onclick="copyToClipboard('${target.x},${target.y}'); return false;" style="color:var(--accent)">
                            (${target.x},${target.y})
                        </a>
                    </div>
                </div>
                <div class="badge" style="background:rgba(255,255,255,0.1); font-size:12px;">${source.dist} Campi</div>
            </div>

            <div class="res-route">
                <div class="route-info" style="text-align:right; flex:1">
                    <div style="font-size:11px; color:#aaa">PARTENZA DA</div>
                    <div style="font-weight:bold; color:#fff">${source.typeName.toUpperCase()}</div>
                    <a href="#" onclick="copyToClipboard('${source.x},${source.y}'); return false;" style="font-family:monospace; color:var(--accent)">
                        (${source.x},${source.y})
                    </a>
                </div>
                <div class="route-arrow">‚ûî</div>
                <div class="route-info" style="flex:1">
                    <div style="font-size:11px; color:#aaa">TRUPPA</div>
                    <div style="font-weight:bold; color:var(--gold)">${troop}</div>
                </div>
            </div>

            <div class="res-time-box">
                <div class="launch-label">LANCIA IL TUO ATTACCO ALLE</div>
                <div class="launch-time">${timeStr}</div>
                <div class="launch-date">${dateStr}</div>
            </div>
            
            <div style="text-align:center">
                <button class="copy-btn" onclick="copyToClipboard('${targetLink}')">Copia Link Bersaglio</button>
            </div>
        </div>`;
        
        container.innerHTML += html;
    }

    function showError(msg) {
        const b = document.getElementById('errorBanner');
        b.innerText = "‚ö†Ô∏è " + msg;
        b.style.display = 'block';
    }
  </script>
</body>
</html>
